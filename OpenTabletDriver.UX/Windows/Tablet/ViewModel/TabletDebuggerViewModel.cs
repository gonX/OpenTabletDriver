using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Collections.Specialized;
using System.IO;
using System.Linq;
using System.Numerics;
using Eto.Forms;
using JetBrains.Annotations;
using OpenTabletDriver.Desktop;
using OpenTabletDriver.Desktop.RPC;
using OpenTabletDriver.Plugin.Tablet;
using OpenTabletDriver.Plugin.Timing;
using OpenTabletDriver.UX.Tools;

#nullable enable

namespace OpenTabletDriver.UX.Windows.Tablet.ViewModel;

public class TabletDebuggerViewModel : Desktop.ViewModel, INotifyCollectionChanged, IDisposable
{
    private const TabletDebuggerEnums.DecodingMode _DEFAULT_DECODING_MODE =
        TabletDebuggerEnums.DecodingMode.Hex;

    private readonly HPETDeltaStopwatch _stopwatch = new();
    private readonly HashSet<string> _seenTablets = [];
    private readonly HashSet<string> _ignoredTablets = [];

    private FileStream? _tabletRecordingFileStream;
    private StreamWriter? _tabletRecordingStreamWriter;

    public TabletDebuggerViewModel()
    {
        _additionalStatistics.CollectionChanged += (sender, args) => this.CollectionChanged?.Invoke(sender, args);
    }

    public void HandleReport(object sender, DebugReportData data) => ReportData = data;

    #region View Model Properties (and backing fields)
    private DebugReportData? _reportData;
    public DebugReportData? ReportData
    {
        get => _reportData;
        private set
        {
            // early exit if ignored
            if (value != null && _ignoredTablets.Contains(GetNameKeyForFilter(value.Tablet, value.Path))) return;

            RaiseAndSetIfChanged(ref _reportData, value);
            if (value == null) return;
            RaiseChanged(nameof(DeviceName));

            if (_seenTablets.Add(GetNameKeyForFilter(value.Tablet, value.Path)))
                RaiseChanged(nameof(ActiveTabletReportMenuItems));

            var timeDelta = _stopwatch.Restart();
            ReportRate += (timeDelta.TotalMilliseconds - ReportRate) * 0.01f;
            AdditionalStatistics["Report Rate"].SaveMinMax(timeDelta.TotalMilliseconds, "ms");

            var dataObject = value.ToObject();

            if (dataObject is IAbsolutePositionReport absolutePositionReport)
                AdditionalStatistics["Position"].SaveMinMax(absolutePositionReport.Position);

            if (dataObject is ITabletReport tabletReport)
                AdditionalStatistics["Pressure"].SaveMinMax(tabletReport.Pressure);

            if (dataObject is IDeviceReport deviceReport)
            {
                SetRawTabletData(deviceReport);
                DecodedTabletData = ReportFormatter.GetStringFormat(deviceReport);
                HandleDataRecording(value, deviceReport, timeDelta);
            }
        }
    }

    public string DeviceName => ReportData?.Tablet.Properties.Name ?? string.Empty;

    // BUG: this is mapped across all reporting tablets
    private double _reportRate;
    public double ReportRate
    {
        get => _reportRate;
        set
        {
            RaiseAndSetIfChanged(ref _reportRate, value);
            RaiseChanged(nameof(ReportRateString));
        }
    }

    public string ReportRateString => $"{Math.Round(1000 / _reportRate)}hz";

    private readonly Statistic _additionalStatistics = new("Additional Statistics");

    public Statistic AdditionalStatistics
    {
        get => _additionalStatistics;
        init => RaiseAndSetIfChanged(ref _additionalStatistics, value);
    }

    private string _rawTabletData = string.Empty;
    public string RawTabletData
    {
        get => _rawTabletData;
        private set => RaiseAndSetIfChanged(ref _rawTabletData, value);
    }

    private string _decodedTabletData = string.Empty;
    public string DecodedTabletData
    {
        get => _decodedTabletData;
        private set => RaiseAndSetIfChanged(ref _decodedTabletData, value);
    }

    private TabletDebuggerEnums.DecodingMode _decodingMode = _DEFAULT_DECODING_MODE;
    public TabletDebuggerEnums.DecodingMode DecodingMode
    {
        get => _decodingMode;
        set => RaiseAndSetIfChanged(ref _decodingMode, value);
    }

    private int _reportsRecorded;
    public int ReportsRecorded
    {
        get => _reportsRecorded;
        private set
        {
            RaiseAndSetIfChanged(ref _reportsRecorded, value);

            if (value > 0 && !HasReportsRecorded)
                HasReportsRecorded = true;
        }
    }

    private bool _hasReportsRecorded;
    public bool HasReportsRecorded
    {
        get => _hasReportsRecorded;
        private set => RaiseAndSetIfChanged(ref _hasReportsRecorded, value);
    }

    private bool _dataRecordingEnabled;
    public bool DataRecordingEnabled
    {
        get => _dataRecordingEnabled;
        [UsedImplicitly]
        set
        {
            RaiseAndSetIfChanged(ref _dataRecordingEnabled, value);

            if (value)
            {
                ReportsRecorded = 0;

                string fileName = "tablet-data_" + DateTimeOffset.UtcNow.ToUnixTimeSeconds() + ".txt";
                _tabletRecordingFileStream = File.OpenWrite(Path.Join(AppInfo.Current.AppDataDirectory, fileName));
                _tabletRecordingStreamWriter = new StreamWriter(_tabletRecordingFileStream);
            }
            else
                CleanupLocks();
        }
    }

    private bool _isVisualizerEnabled = true;
    public bool IsVisualizerEnabled
    {
        get => _isVisualizerEnabled;
        set => RaiseAndSetIfChanged(ref _isVisualizerEnabled, value);
    }

    private bool _showAdditionalStatistics;
    public bool ShowAdditionalStatistics
    {
        get => _showAdditionalStatistics;
        set => RaiseAndSetIfChanged(ref _showAdditionalStatistics, value);
    }

    public IEnumerable<CheckMenuItem> ActiveTabletReportMenuItems => GenerateMenuItem(_seenTablets, _ignoredTablets);

    #endregion

    #region Class Functions

    private void SetRawTabletData(IDeviceReport report)
    {
        RawTabletData = DecodingMode switch
        {
            TabletDebuggerEnums.DecodingMode.Hex => ReportFormatter.GetStringRaw(report),
            TabletDebuggerEnums.DecodingMode.Binary => ReportFormatter.GetStringRawAsBinary(report),
            _ => throw new NotImplementedException(),
        };
    }

    private void HandleDataRecording(DebugReportData reportData, IDeviceReport report, TimeSpan timeDelta)
    {
        if (!DataRecordingEnabled || _tabletRecordingStreamWriter == null)
            return;

        string? output = ReportFormatter.GetStringFormatOneLine(reportData.Tablet.Properties,
            report,
            timeDelta,
            reportData.Path);

        _tabletRecordingStreamWriter.WriteLine(output);
        ReportsRecorded++;
    }

    #endregion

    #region Static Functions

    private static IEnumerable<CheckMenuItem> GenerateMenuItem(HashSet<string> seenIDs, HashSet<string> ignoredIDs)
    {
        foreach (string id in seenIDs)
        {
            bool isIgnored = ignoredIDs.Contains(id);

            var command = new CheckCommand(HandleCheckCommand)
            {
                Checked = !isIgnored,
                Tag = (id, seenIDs, ignoredIDs),
            };

            var menuItem = new CheckMenuItem(command)
            {
                Text = id,
            };

            yield return menuItem;
        }
    }

    private static void HandleCheckCommand(object? sender, EventArgs e)
    {
        if (sender is not CheckCommand checkCommand) return;

        (string name, var seenIDs, var ignoredIDs) = (ValueTuple<string, HashSet<string>, HashSet<string>>)checkCommand.Tag;

        if (checkCommand.Checked)
            ignoredIDs.Remove(name);
        else if (seenIDs.Count > ignoredIDs.Count + 1) // don't allow removing last entry
            ignoredIDs.Add(name);
        else
            checkCommand.Checked = true;
    }

    private static string GetNameKeyForFilter(TabletReference tabletReference, string path) =>
        $"{tabletReference.Properties.Name}: {path}";

    #endregion

    #region Cleanup/Management

    private void CleanupLocks()
    {
        _tabletRecordingStreamWriter?.Dispose();
        _tabletRecordingStreamWriter = null;
        _tabletRecordingFileStream?.Dispose();
        _tabletRecordingFileStream = null;
    }

    public void Dispose()
    {
        CleanupLocks();
        GC.SuppressFinalize(this);
    }

    #endregion

    public event NotifyCollectionChangedEventHandler? CollectionChanged;
}

public static class TabletDebuggerEnums
{
    public enum DecodingMode
    {
        Hex,
        Binary
    }
}

public class Statistic : Desktop.ViewModel, INotifyCollectionChanged
{
    private readonly string _name = null!;
    private object? _value;
    private string? _unit;
    private string _valueStringFormat;
    private ObservableCollection<Statistic> _children = [];

    public Statistic(string name, string? value = null, string? unit = null, string? valueStringFormat = null)
    {
        Name = name;
        Value = value;
        _unit = unit;
        _valueStringFormat = valueStringFormat ?? "{0}";
        Children.CollectionChanged += (sender, args) => CollectionChanged?.Invoke(sender, args);
    }

    public ObservableCollection<Statistic> Children
    {
        get => _children;
        set => RaiseAndSetIfChanged(ref _children, value);
    }

    public string Name
    {
        get => _name;
        private init => RaiseAndSetIfChanged(ref _name, value);
    }

    public object? Value
    {
        get => _value;
        set
        {
            RaiseAndSetIfChanged(ref _value, value);
            RaiseChanged(nameof(ValueString));
        }
    }

    public string? Unit
    {
        get => _unit;
        set => RaiseAndSetIfChanged(ref _unit, value);
    }

    public string ValueStringFormat
    {
        get => _valueStringFormat;
        set
        {
            RaiseAndSetIfChanged(ref _valueStringFormat, value);
            RaiseChanged(nameof(ValueString));
        }
    }

    public string ValueString => Value != null ? string.Format(ValueStringFormat, Value) : "<null>";

    public Statistic this[string childName]
    {
        get
        {
            var rv = Children.FirstOrDefault(x => x.Name == childName);
            if (rv == null) Children.Add(rv = new Statistic(childName));
            return rv;
        }
    }

    public Statistic SaveMinMax(double source, string? unit = null, int precision = 2) => SaveMinMax(source, Math.Min, Math.Max, unit, precision);
    public Statistic SaveMinMax(uint source, string? unit = null) => SaveMinMax(source, Math.Min, Math.Max, unit, null);
    public Statistic SaveMinMax(Vector2 source, string? unit = null, int precision = 0) => SaveMinMax(source, Vector2.Min, Vector2.Max, unit, precision);

    private Statistic SaveMinMax<T>(T source, Func<T, T, T> minFunc, Func<T, T, T> maxFunc, string? unit, int? precision)
    {
        var min = this["Min"];
        min.Value = minFunc(source, (T)(min.Value ?? source)!);
        min.Unit = unit;
        var max = this["Max"];
        max.Value = maxFunc(source, (T)(max.Value ?? source)!);
        max.Unit = unit;

        if (precision != null)
        {
            ArgumentOutOfRangeException.ThrowIfNegative(precision.Value, nameof(precision));
            string format;

            if (precision.Value == 0)
                format = "{0:0}";
            else
                format = "{0:0." + string.Concat(Enumerable.Repeat("0", precision.Value)) + "}";

            min.ValueStringFormat = max.ValueStringFormat = format;
        }

        return this;
    }

    public event NotifyCollectionChangedEventHandler? CollectionChanged;
}
